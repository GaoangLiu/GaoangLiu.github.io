---
layout: post
title: The mysterious Mistral (WIP)
date: 2024-01-11
tags: mistral moe
categories: nlp
author: GaoangLiu
---
* content
{:toc}






Mistral.ai åœ¨ arXiv ä¸Šæ”¾å‡ºæ¥è®ºæ–‡ [Mixtral of Experts](https://arxiv.org/pdf/2401.04088.pdf)ã€‚




Q: å¤§ä½“æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ

Q: router network æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿæ€ä¹ˆé€‰æ‹©ï¼Œæ€ä¹ˆç»„åˆï¼Ÿ
a router network selects two experts to process the current state and combine their outputs. 

Q: ä¸ºä»€ä¹ˆè¦ç”¨ router networkï¼Ÿ

Q: ä¸ºä»€ä¹ˆè¦ç”¨ä¸¤ä¸ªexpertï¼Ÿ


# Mistral 7B
è®ºæ–‡: https://arxiv.org/pdf/2310.06825.pdf, arXiv 23.10

é¦–å…ˆè¯´ä¸€ä¸‹å½“æ—¶è¿™ç¯‡å·¥ä½œçš„äº®ç‚¹ï¼š
1. åœ¨æ‰€æœ‰åŸºå‡†æµ‹è¯•ä¸­å‡ä¼˜äºå½“æ—¶æœ€ä½³å¼€æºæ¨¡å‹ Llama 2 13Bï¼Œåœ¨æ¨ç†ã€æ•°å­¦å’Œä»£ç ç”Ÿæˆæ–¹é¢ä¼˜äº Llama 1 34Bã€‚
2. åˆ©ç”¨åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›ï¼ˆGQAï¼‰æ¥å®ç°æ›´å¿«çš„æ¨ç†ï¼Œå¹¶ç»“åˆæ»‘åŠ¨çª—å£æ³¨æ„åŠ›ï¼ˆSWAï¼‰æ¥æœ‰æ•ˆåœ°å¤„ç†ä»»æ„é•¿åº¦çš„åºåˆ—ï¼ŒåŒæ—¶é™ä½æ¨ç†æˆæœ¬ã€‚
3. æä¾›äº†ä¸€ä¸ªç»è¿‡æŒ‡ä»¤å¾®è°ƒçš„æ¨¡å‹ï¼ŒMistral 7B-Instructï¼Œåœ¨äººç±»å’Œè‡ªåŠ¨åŒ–åŸºå‡†æµ‹è¯•ä¸Šéƒ½è¶…è¶Šäº† Llama 2 13B èŠå¤©æ¨¡å‹ã€‚

# Sliding Window Attention (SWA) 
åœ¨ vanilla attention ä¸­ï¼Œæ¯ä¸ª token éƒ½ä¼šä¸æ‰€æœ‰å…¶ä»– token è¿›è¡Œäº¤äº’ï¼Œè¿™æ ·çš„è¯ï¼Œè®¡ç®—å¤æ‚åº¦å°±æ˜¯ $$O(n^2)$$ï¼Œå…¶ä¸­ $$n$$ æ˜¯åºåˆ—é•¿åº¦ã€‚è¿™æ ·çš„è®¡ç®—å¤æ‚åº¦åœ¨åºåˆ—å¾ˆé•¿æ—¶ä¼šå¾ˆé«˜ï¼Œå› æ­¤éœ€è¦ä¸€ç§æ›´é«˜æ•ˆçš„æ–¹æ³•ã€‚

SWA æœ€æ—©åœ¨ [LongFormer](https://arxiv.org/pdf/2004.05150.pdf)ä¸­æå‡ºï¼Œå®ƒçš„æ€æƒ³æ˜¯æŠŠæ¯ä¸ª token çš„æ³¨æ„åŠ›è·¨åº¦é™åˆ¶åˆ°å®ƒå‘¨å›´çš„å›ºå®šçª—å£ä¸­ã€‚LongFormerçš„åšæ³•æ˜¯å®šä¹‰ä¸€ä¸ªå®½åº¦ä¸º$$W$$çš„çª—å£ï¼Œä½¿å¾— query èŠ‚ç‚¹åªèƒ½æ³¨æ„åˆ°å¯¹ç­‰çš„ key èŠ‚ç‚¹ä»¥åŠ key nodes å·¦å³ $$W/2$$ ä¸ªèŠ‚ç‚¹ã€‚è¿™æ ·çš„è¯ï¼Œè®¡ç®—å¤æ‚åº¦å°±æ˜¯ $$O(W \cdot n)$$ï¼Œå…¶ä¸­ $$n$$ æ˜¯åºåˆ—é•¿åº¦ã€‚å½“ $$W<<n$$ï¼Œè®¡ç®—å¤æ‚åº¦å°±ä¼šå¤§å¤§é™ä½ã€‚

è¿™æ ·ï¼Œå…¶ä»– key nodes çš„ä¿¡æ¯æ˜¯ä¸æ˜¯ä¸¢å¤±äº†ï¼Ÿä¹Ÿä¸æ˜¯ï¼Œå¤šä¸ªå±‚å †å åœ¨ä¸€èµ·æ—¶ï¼Œåœ¨é«˜å±‚ä¸Šï¼Œquery èŠ‚ç‚¹ä¼šé—´æ¥çš„æ³¨æ„åˆ°è¿œå¤„çš„ key èŠ‚ç‚¹ã€‚å‡è®¾æœ‰ $$l$$ å±‚ï¼Œæ¯å±‚çš„çª—å£å¤§å°ä¸º $$W$$ï¼Œé‚£ä¹ˆåœ¨ç¬¬ $$l$$ å±‚ï¼Œquery èŠ‚ç‚¹å¯ä»¥é—´æ¥çš„æ³¨æ„åˆ° $$W*l$$ èŒƒå›´å†…çš„ key èŠ‚ç‚¹ã€‚

Mistral 7B ä¸­çš„ window size æ˜¯ 4096.

# Sparse Mixtures of Experts
ç»™å®šè¾“å…¥ $$x$$ï¼ŒMoE æ¨¡å—çš„è¾“å‡º $$y=\sum_{i=0}^{n-1} G(x)_i \cdot E_i(x)$$ï¼Œå…¶ä¸­ $$n$$ æ˜¯ä¸“å®¶ç½‘ç»œï¼ˆä¸‹ç§°ä¸“å®¶ï¼‰çš„ä¸ªæ•°ï¼Œ$$G(x)$$ æ˜¯ç¬¬$$i$$ä¸“å®¶çš„æƒé‡ï¼Œ$$E_i(x)$$ æ˜¯ç¬¬ $$i$$ ä¸ªä¸“å®¶çš„è¾“å‡ºã€‚$$G(x)$$ çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªæ¦‚ç‡å€¼ï¼Œä¸”æ»¡è¶³ $$\sum_{i=0}^{n-1} G(x)_i = 1$$ã€‚

é‚£ SMoE ä¸­çš„ sparse æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå…¶å®å°±æ˜¯æŒ‡åªæœ‰å°‘æ•°ä¸“å®¶å‚ä¸å†³ç­–ï¼Œå³ $$G(x)$$ ä¸­çš„å¤§éƒ¨åˆ†å…ƒç´ éƒ½æ˜¯ 0ï¼Œåªæœ‰å°‘éƒ¨åˆ†éé›¶ã€‚è¿™æ ·çš„è¯ï¼Œå°±å¯ä»¥å‡å°‘è®¡ç®—é‡ã€‚æ—¢ç„¶åªæœ‰å°‘æ•°ä¸“å®¶å‚ä¸å†³ç­–ï¼Œé‚£å°±éœ€è¦ä¸€ä¸ªç­–ç•¥å†³å®šå“ªäº›ä¸“å®¶å‚ä¸å†³ç­–ï¼Œæ–¹æ³•æœ‰å¾ˆå¤šç§ï¼Œä¸€ç§ç®€å•é«˜æ•ˆçš„æ–¹æ³•æ˜¯å¯¹çº¿æ€§å±‚çš„å‰Kä¸ªlogitsåº”ç”¨softmaxå‡½æ•°ï¼š

$$G(x)=\text{Softmax}(\text{TopK}(x \cdot W_g))$$

$$k$$ åšä¸ºä¸€ä¸ªè¶…å‚æ•°ï¼Œå¯ä»¥é€šè¿‡å¹³è¡¡æ•ˆæœä¸è®¡ç®—é‡æ¥è°ƒæ•´ã€‚Mistral 8x7B ä¸­ä½¿ç”¨çš„æ˜¯ $$k=2$$ï¼Œå³åªæœ‰ä¸¤ä¸ªä¸“å®¶å‚ä¸å†³ç­–ã€‚

# ç›´æ¥åå¥½ä¼˜åŒ–
what, why, how?

ç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDirect Perference Optimization,DPOï¼‰æ˜¯ä¸€ç§ LM åå¥½å¯¹é½ç®—æ³•ï¼Œæœ€åˆ Rafailov ç­‰äººåœ¨ [ã€ŠDirect Preference Optimization: Your Language Model is Secretly a Reward Modelã€‹](https://arxiv.org/abs/2305.18290) ä¸­æå‡ºã€‚

åœ¨æ­¤ä¹‹å‰ï¼Œè®©LMå¯¹äººç±»åå¥½å¯¹é½å¸¸ç”¨çš„ç®—æ³•æ˜¯RLHFï¼Œæ€è·¯æ˜¯å…ˆæ ¹æ®äººç±»åå¥½æ‹Ÿåˆä¸€ä¸ªå¥–åŠ±æ¨¡å‹ï¼Œå†ç”¨å¼ºåŒ–å­¦ä¹ çš„æ–¹æ³•å»å¾®è°ƒä¸€ä¸ªLMï¼Œä½¿å¾—LMçš„è¾“å‡ºå°½å¯èƒ½å¥–åŠ±æœ€å¤§åŒ–ã€‚ä½†RLHFå¤æ‚ï¼Œä¸”ä¸ç¨³å®šã€‚

ä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ
ç¨³å®šã€æ•ˆæœå¥½ã€è®¡ç®—é‡å°ã€‚

å…ˆè¯´ç¨³å®šã€‚ 

## RLHF çš„ä¸‰ä¸ªé˜¶æ®µ 
ç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯**æœ‰ç›‘ç£å¾®è°ƒï¼ˆsuperivsed fine-tuning, STFï¼‰**ï¼šä½¿ç”¨é«˜è´¨é‡æ•°æ®é›†å¯¹ LM è¿›è¡Œæœ‰ç›‘ç£å¾®è°ƒï¼Œè¾“å‡ºæ¨¡å‹ $$\pi^\text{SFT}$$ã€‚


ç¬¬äºŒé˜¶æ®µæ˜¯å¥–åŠ±æ¨¡å‹è®­ç»ƒï¼ˆreward modelingï¼‰ï¼Œç»™å®šä¸€ä¸ª prompt $$x$$, ç”¨ $$\pi^\text{SFT}(y \vert x)$$ è¾“å‡ºä¸¤ä¸ªåºåˆ— $$y_1$$ å’Œ $$y_2$$ï¼Œç„¶åäººç±»é€‰æ‹©æ›´å¥½çš„é‚£ä¸ªåºåˆ— $$y_w \succ y_l$$ï¼Œè¿™æ ·å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªæ•°æ®é›† $$\mathcal{D}=\{(x, y_w, y_l)\}$$ã€‚å‡è®¾è¿™ä¸ªå€¾å‘æ•°æ®é›†æ˜¯ç”±ä¸€ä¸ª latent reward model $$r_\theta(y,x)$$ ç”Ÿæˆçš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨æœ€å¤§ä¼¼ç„¶ä¼°è®¡ï¼ˆMLEï¼‰æ¥è®­ç»ƒå¥–åŠ±æ¨¡å‹ï¼Œä½¿å¾— $$r_\theta(y_w,x) > r_\theta(y_l,x)$$ã€‚

Bradley-Terry æ¨¡å‹æ˜¯ä¸€ç§å¸¸ç”¨çš„åå¥½æ¨¡å‹ï¼Œå®ƒå‡è®¾äººç±»åå¥½åˆ†å¸ƒ$$p(y_1 \succ y_2 \vert x)$$å¯ä»¥ç”± $$r_\theta(y, x)$$ ç”Ÿæˆï¼Œå³ $$p(y_1 \succ y_2 \vert x) = \frac{\exp(r_\theta(y_1,x))}{\exp(r_\theta(y_1,x)) + \exp(r_\theta(y_2,x))}$$ã€‚é‚£ä¹ˆæœ€å¤§ä¼¼ç„¶ä¼°è®¡å°±æ˜¯ $$\theta^* = \arg\max_\theta \sum_{(x, y_w, y_l) \in \mathcal{D}} \log \frac{\exp(r_\theta(y_w,x))}{\exp(r_\theta(y_w,x)) + \exp(r_\theta(y_l,x))}$$ï¼Œå…¶ä¸­ $$D$$ æ˜¯å€¾å‘æ•°æ®é›†ã€‚

æœ€ç»ˆå¾—åˆ°çš„ $$r_\theta^*$$ å°±æ˜¯ä¸€ä¸ªå¥–åŠ±æ¨¡å‹ï¼Œå®ƒå¯ä»¥ç”¨æ¥è¯„ä¼°ä¸€ä¸ªåºåˆ—çš„å¥½åã€‚

ç¬¬ä¸‰é˜¶æ®µæ˜¯**å¼ºåŒ–å­¦ä¹ å¾®è°ƒï¼ˆRL fine-tuning, RLFTï¼‰**ï¼Œä½¿ç”¨ $$r_\theta^*$$ ä½œä¸ºå¥–åŠ±å‡½æ•°ï¼Œå¯¹ $$\pi^\text{SFT}$$ è¿›è¡Œå¼ºåŒ–å­¦ä¹ å¾®è°ƒï¼Œå¾—åˆ°æœ€ç»ˆçš„æ¨¡å‹ $$\pi^\theta$$ã€‚ç­‰åŒäºä»¥ä¸‹ä¼˜åŒ–é—®é¢˜ï¼š

$$\max_{\pi^\theta} \mathbb{E}_{x \sim \mathcal{D}, y \sim \pi^\theta(y\vert x)}[r_\theta^*(y,x)] - \beta \cdot \mathbb{D}_{KL}(\pi^\theta(y \vert x)  \vert  \vert  \pi^\text{SFT}(y \vert x))$$

å…¶ä¸­ $$\beta$$ æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œç”¨æ¥å¹³è¡¡ä¸¤ä¸ªç›®æ ‡ã€‚






### ğŸ“ ä¸€äº›ä¸å†³ç­–ç›¸å…³çš„å·¥ä½œ 
- [Unified scaling laws for routed language models](https://arxiv.org/abs/2202.01169)
- [Dselect-k: Differentiable selection in the mixture of experts with applications to multi-task learning](https://proceedings.neurips.cc/paper/2021/hash/f5ac21cd0ef1b88e9848571aeb53551a-Abstract.html)
- [CommonsenseQA: A Question Answering Challenge Targeting Commonsense Knowledge](https://arxiv.org/abs/1811.00937)
 
Mistral çš„ MoE å±‚ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<figure style="text-align: center;">
    <img src="https://image.ddot.cc/202401/mistral-moe-layer_20240111_1038.png" width=789pt>
    <figcaption style="text-align:center"> Mistral MoE layer ç»“æ„å›¾ </figcaption>
</figure>

é‚£è¿™ä¸ª router æ˜¯æ€ä¹ˆå·¥ä½œçš„å‘¢ï¼Ÿ

ä»ä¸Šé¢çš„ç»“æ„å›¾é‡Œå¯ä»¥çŸ¥é“æ¯ä¸€ä¸ª router æ˜¯ä¸€ä¸ª gating networkï¼Œå®ƒçš„è¾“å…¥æ˜¯ $$x$$ï¼Œè¾“å‡ºæ˜¯ $$G(x)$$ï¼Œå³æ¯ä¸ªä¸“å®¶çš„æƒé‡ã€‚è¿™ä¸ª gating network åšä¸ºæ•´ä¸ªæ¨¡å‹çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨è®­ç»ƒæ—¶å‚æ•° $$W_g$$ ä¹Ÿæ˜¯é€šè¿‡åå‘ä¼ æ’­æ¥æ›´æ–°çš„ã€‚ä¸€æ—¦è®­ç»ƒå®Œæˆï¼Œæ¨ç†è¿‡ç¨‹ä¸­ç›´æ¥ä½¿ç”¨ $$G(x)$$ çš„å€¼å³å¯ã€‚


